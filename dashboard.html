<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HUMO Lab | Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #020202; color: #e5e5e5; overflow: hidden; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Background & Effects */
        .immersive-bg { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -1; overflow: hidden; background: #020202; }
        .orb { position: absolute; border-radius: 50%; filter: blur(100px); opacity: 0.4; animation: float 25s infinite ease-in-out; }
        .orb-1 { top: -15%; right: -10%; width: 50vw; height: 50vw; background: radial-gradient(circle, #10b981 0%, transparent 70%); }
        .orb-2 { bottom: -20%; left: -10%; width: 60vw; height: 60vw; background: radial-gradient(circle, #064e3b 0%, transparent 70%); animation-delay: -8s; opacity: 0.25; }
        .orb-3 { top: 40%; left: 30%; width: 40vw; height: 40vw; background: radial-gradient(circle, #047857 0%, transparent 70%); opacity: 0.15; animation-delay: -15s; }
        @keyframes float { 0%, 100% { transform: translate(0, 0) scale(1); } 33% { transform: translate(30px, -50px) scale(1.1); } 66% { transform: translate(-20px, 20px) scale(0.95); } }
        
        .tech-grid { position: fixed; inset: 0; z-index: -1; background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px); background-size: 50px 50px; mask-image: radial-gradient(circle at center, black 30%, transparent 80%); pointer-events: none; }

        /* Scrollbars */
        ::-webkit-scrollbar { width: 4px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: rgba(16, 185, 129, 0.2); border-radius: 3px; }

        /* UI Components */
        .glass-panel { background: rgba(10, 10, 10, 0.4); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08); transition: border-color 0.3s ease; }
        .side-panel { background: rgba(5, 5, 5, 0.3); backdrop-filter: blur(10px); }
        .glass-input { background: rgba(0, 0, 0, 0.6); border: 1px solid rgba(16, 185, 129, 0.3); color: #10b981; }
        .glass-input:focus { outline: none; border-color: #10b981; box-shadow: 0 0 15px rgba(16, 185, 129, 0.2); }
        
        /* KPI Cards */
        .kpi-card { background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 0.75rem; position: relative; overflow: hidden; }
        .kpi-card::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: linear-gradient(90deg, transparent, #10b981, transparent); opacity: 0.5; }
        .kpi-value { font-family: 'JetBrains Mono', monospace; font-size: 1.5rem; font-weight: bold; color: white; letter-spacing: -0.05em; }
        .kpi-label { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.1em; color: #9ca3af; margin-bottom: 0.25rem; }

        /* Animations */
        .active-terminal { box-shadow: 0 0 40px rgba(16, 185, 129, 0.05); animation: border-breathe 4s infinite ease-in-out; }
        @keyframes border-breathe { 0%, 100% { border-color: rgba(255, 255, 255, 0.08); } 50% { border-color: rgba(16, 185, 129, 0.3); } }
        
        .status-dot { width: 8px; height: 8px; background-color: #10b981; border-radius: 50%; box-shadow: 0 0 10px #10b981; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in forwards; opacity: 0; }
        @keyframes fadeIn { to { opacity: 1; } }
        
        .view-btn.active { background-color: rgba(16, 185, 129, 0.2); color: #10b981; border-color: #10b981; }
        .view-btn { border: 1px solid transparent; }
    </style>
</head>
<body class="h-screen flex flex-col">

    <div class="immersive-bg"><div class="orb orb-1"></div><div class="orb orb-2"></div><div class="orb orb-3"></div><div class="tech-grid"></div></div>

    <!-- Header -->
    <header class="h-14 border-b border-white/10 flex items-center justify-between px-6 bg-black/40 backdrop-blur-md z-50">
        <div class="flex items-center gap-3">
            <div class="status-dot animate-pulse"></div>
            <h1 class="font-bold tracking-[0.2em] text-sm md:text-lg">HUMO <span class="text-emerald-500 font-normal opacity-80">LAB CONSOLE</span></h1>
        </div>
        <div class="flex items-center gap-6 text-[10px] font-mono text-gray-500">
            <div class="hidden md:block">LATENCY: <span class="text-emerald-400">24ms</span></div>
            <div>AI ENGINE: <span class="text-emerald-500 font-bold">ONLINE</span></div>
        </div>
    </header>

    <!-- Main Layout -->
    <main class="flex-1 grid grid-cols-12 gap-0 overflow-hidden relative z-10">
        
        <!-- Left: Users -->
        <aside class="col-span-3 border-r border-white/5 side-panel flex flex-col">
            <div class="p-3 border-b border-white/5 flex justify-between items-center bg-white/5">
                <h2 class="text-[10px] font-bold uppercase tracking-widest text-gray-400 flex items-center gap-2"><i data-lucide="database" class="w-3 h-3"></i> Data Lake</h2>
                <button onclick="fetchUsers()" class="text-gray-500 hover:text-white"><i data-lucide="refresh-cw" class="w-3 h-3"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-2 space-y-1 relative" id="user-list">
                <div class="absolute inset-0 flex items-center justify-center text-emerald-500/50"><i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i></div>
            </div>
        </aside>

        <!-- Center: Terminal/War Room -->
        <section class="col-span-6 flex flex-col relative glass-panel active-terminal mx-2 my-2 rounded-xl overflow-hidden shadow-[0_0_50px_rgba(0,0,0,0.5)]">
            <!-- Toggle -->
            <div class="absolute top-3 left-0 right-0 flex justify-center gap-2 z-20">
                <button onclick="switchView('chat')" id="btn-chat" class="view-btn active px-3 py-1 rounded-full text-[9px] uppercase tracking-widest font-bold text-gray-400 bg-black/60 hover:text-white transition flex items-center gap-2 backdrop-blur-sm"><i data-lucide="message-square" class="w-3 h-3"></i> AI Chat</button>
                <button onclick="switchView('metrics')" id="btn-metrics" class="view-btn px-3 py-1 rounded-full text-[9px] uppercase tracking-widest font-bold text-gray-400 bg-black/60 hover:text-white transition flex items-center gap-2 backdrop-blur-sm"><i data-lucide="bar-chart-2" class="w-3 h-3"></i> War Room</button>
            </div>

            <!-- Chat View -->
            <div id="view-chat" class="flex flex-col h-full pt-10 relative z-10 transition-opacity duration-300">
                <div class="flex-1 overflow-y-auto p-6 space-y-6" id="chat-history">
                    <div class="flex gap-4 items-start animate-fade-in">
                        <div class="w-8 h-8 rounded-full bg-emerald-500/10 border border-emerald-500/30 flex items-center justify-center shrink-0"><i data-lucide="brain-circuit" class="w-4 h-4 text-emerald-500"></i></div>
                        <div class="space-y-1">
                            <div class="text-[9px] text-emerald-500 font-mono uppercase">System Core</div>
                            <div class="text-xs text-gray-300 leading-relaxed">Bienvenido, Operador. Sistema listo para an谩lisis o conversaci贸n.</div>
                        </div>
                    </div>
                </div>
                <div class="p-3 bg-black/40 border-t border-white/5">
                    <form id="ai-form" class="flex gap-2" onsubmit="handleAiSubmit(event)">
                        <input type="text" id="ai-input" class="glass-input w-full px-3 py-2 rounded font-mono text-xs placeholder-emerald-900/50" placeholder="Comando o ID..." autocomplete="off">
                        <button type="submit" class="bg-emerald-600 hover:bg-emerald-500 text-black px-4 rounded transition"><i data-lucide="send" class="w-3 h-3"></i></button>
                    </form>
                </div>
            </div>

            <!-- War Room View (Expanded) -->
            <div id="view-metrics" class="hidden h-full pt-14 p-4 relative z-10 overflow-y-auto custom-scroll">
                
                <!-- KPI DECK (Financiero & Conversi贸n) -->
                <div class="grid grid-cols-4 gap-3 mb-4">
                    <div class="kpi-card">
                        <div class="kpi-label">MRR Proyectado</div>
                        <div class="kpi-value text-emerald-400">$<span id="kpi-mrr">0</span></div>
                        <div class="text-[9px] text-emerald-500/70 mt-1 flex items-center gap-1"><i data-lucide="trending-up" class="w-3 h-3"></i> +0%</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Tasa Conversi贸n</div>
                        <div class="kpi-value text-blue-400"><span id="kpi-conv">0</span>%</div>
                        <div class="text-[9px] text-gray-500 mt-1">Visita -> Registro</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Wallet Installs</div>
                        <div class="kpi-value text-white"><span id="kpi-wallet">0</span></div>
                        <div class="text-[9px] text-gray-500 mt-1">Activos en Pass</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Physical Scans</div>
                        <div class="kpi-value text-yellow-400"><span id="kpi-scans">0</span></div>
                        <div class="text-[9px] text-gray-500 mt-1">ltimas 24h</div>
                    </div>
                </div>

                <!-- Gr谩ficas Principales -->
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <!-- Tr谩fico vs Conversi贸n -->
                    <div class="col-span-2 bg-black/40 border border-white/10 rounded-xl p-3 h-48">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-[10px] text-emerald-400 font-bold uppercase tracking-widest">Flujo de Adquisici贸n</h3>
                            <span class="text-[9px] text-gray-500 font-mono">LIVE UPDATE</span>
                        </div>
                        <div class="h-full w-full pb-4"><canvas id="trafficChart"></canvas></div>
                    </div>

                    <!-- Financial Mix -->
                    <div class="bg-black/40 border border-white/10 rounded-xl p-3 h-40">
                        <h3 class="text-[10px] text-emerald-400 font-bold uppercase tracking-widest mb-2">Revenue Mix</h3>
                        <div class="h-full w-full flex justify-center pb-4"><canvas id="financeChart"></canvas></div>
                    </div>

                    <!-- Wallet OS -->
                    <div class="bg-black/40 border border-white/10 rounded-xl p-3 h-40">
                        <h3 class="text-[10px] text-emerald-400 font-bold uppercase tracking-widest mb-2">Tecnolog铆a Wallet</h3>
                        <div class="h-full w-full flex justify-center pb-4 relative">
                            <canvas id="walletOSChart"></canvas>
                            <div class="absolute inset-0 flex items-center justify-center pointer-events-none mt-2"><i data-lucide="smartphone" class="w-4 h-4 text-white/20"></i></div>
                        </div>
                    </div>

                    <!-- Arquetipos -->
                    <div class="bg-black/40 border border-white/10 rounded-xl p-3 h-48">
                        <h3 class="text-[10px] text-emerald-400 font-bold uppercase tracking-widest mb-2">Radar de Comportamiento</h3>
                        <div class="h-full w-full flex justify-center pb-4"><canvas id="radarChart"></canvas></div>
                    </div>

                    <!-- Retention/Churn -->
                    <div class="bg-black/40 border border-white/10 rounded-xl p-3 h-48">
                        <h3 class="text-[10px] text-emerald-400 font-bold uppercase tracking-widest mb-2">Retenci贸n de Pases</h3>
                        <div class="h-full w-full pb-4"><canvas id="walletStatusChart"></canvas></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Right: Live Feed -->
        <aside class="col-span-3 border-l border-white/5 side-panel flex flex-col">
            <div class="p-3 border-b border-white/5 bg-white/5 flex justify-between items-center">
                <h2 class="text-[10px] font-bold uppercase tracking-widest text-gray-400 flex items-center gap-2"><i data-lucide="activity" class="w-3 h-3"></i> Event Stream</h2>
                <div class="w-1.5 h-1.5 bg-red-500 rounded-full animate-pulse"></div>
            </div>
            <div class="flex-1 overflow-y-auto p-3 font-mono text-[9px] space-y-2" id="live-feed"></div>
        </aside>
    </main>

    <script>
        lucide.createIcons();
        const API_URL = "https://humo-api.smartpasses.workers.dev";
        const BRAIN_URL = "https://worker-ai.smartpasses.workers.dev";
        
        let selectedUserId = null;
        let charts = {};

        function switchView(view) {
            const chatView = document.getElementById('view-chat');
            const metricsView = document.getElementById('view-metrics');
            const btnChat = document.getElementById('btn-chat');
            const btnMetrics = document.getElementById('btn-metrics');

            if (view === 'chat') {
                chatView.classList.remove('hidden'); metricsView.classList.add('hidden');
                btnChat.classList.add('active'); btnMetrics.classList.remove('active');
            } else {
                chatView.classList.add('hidden'); metricsView.classList.remove('hidden');
                btnChat.classList.remove('active'); btnMetrics.classList.add('active');
                setTimeout(initCharts, 100); // Delay para renderizado correcto
            }
        }

        // --- CHART CONFIGURATION ---
        function initCharts() {
            if (charts.traffic) return;
            Chart.defaults.color = '#6b7280';
            Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.05)';
            Chart.defaults.font.family = "'JetBrains Mono', monospace";
            Chart.defaults.font.size = 9;

            // 1. Traffic vs Conversion
            const ctxTraffic = document.getElementById('trafficChart').getContext('2d');
            charts.traffic = new Chart(ctxTraffic, {
                type: 'line',
                data: {
                    labels: Array(10).fill(''),
                    datasets: [
                        { label: 'Visitas', data: [5, 8, 12, 19, 15, 22, 30, 25, 28, 35], borderColor: '#3b82f6', tension: 0.4, borderWidth: 1, pointRadius: 0 },
                        { label: 'Registros', data: [1, 2, 3, 5, 4, 6, 8, 7, 9, 10], borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true, tension: 0.4, borderWidth: 1, pointRadius: 2 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'top', align: 'end', labels: { boxWidth: 8 } } }, scales: { x: { display: false }, y: { display: false } } }
            });

            // 2. Finance Mix (Bar)
            const ctxFin = document.getElementById('financeChart').getContext('2d');
            charts.finance = new Chart(ctxFin, {
                type: 'bar',
                data: {
                    labels: ['Free', 'Pro', 'Club'],
                    datasets: [{
                        label: 'MRR', data: [0, 1400, 5000], backgroundColor: ['#374151', '#10b981', '#fbbf24'], borderRadius: 3, barThickness: 25
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { display: false } } }
            });

            // 3. Wallet OS
            const ctxOS = document.getElementById('walletOSChart').getContext('2d');
            charts.os = new Chart(ctxOS, {
                type: 'doughnut',
                data: { labels: ['Apple', 'Google'], datasets: [{ data: [65, 35], backgroundColor: ['#fff', '#10b981'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { display: false } } }
            });

            // 4. Radar Arquetipos
            const ctxRadar = document.getElementById('radarChart').getContext('2d');
            charts.radar = new Chart(ctxRadar, {
                type: 'radar',
                data: {
                    labels: ['Curioso', 'Pro', 'Social', 'Elite', 'Fantasma'],
                    datasets: [{ label: 'User Types', data: [50, 30, 20, 10, 40], backgroundColor: 'rgba(16, 185, 129, 0.2)', borderColor: '#10b981', borderWidth: 1, pointRadius: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { r: { ticks: { display: false }, pointLabels: { color: '#6b7280', font: { size: 8 } }, grid: { color: 'rgba(255,255,255,0.05)' } } } }
            });

            // 5. Retention
            const ctxRet = document.getElementById('walletStatusChart').getContext('2d');
            charts.retention = new Chart(ctxRet, {
                type: 'bar',
                data: {
                    labels: ['Activos', 'Eliminados'],
                    datasets: [{ data: [120, 8], backgroundColor: ['#3b82f6', '#ef4444'], borderRadius: 3, barThickness: 15 }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { grid: { display: false } } } }
            });
        }

        // --- DATA UPDATES ---
        async function fetchStats() {
            try {
                const res = await fetch(`${API_URL}/stats`);
                const data = await res.json();
                
                // Actualizar KPIs Deck
                document.getElementById('stat-users').innerText = data.users || 0;
                document.getElementById('stat-events').innerText = data.events || 0;
                
                // C谩lculos simulados para Financials (hasta tener data real)
                const mockMRR = (data.users * 0.1 * 70) + (2 * 99); // 10% conversion est.
                document.getElementById('kpi-mrr').innerText = Math.floor(mockMRR);
                
                // Update Traffic Chart (Simulaci贸n)
                if (charts.traffic) {
                    const newVisits = Math.floor(Math.random() * 10) + 20;
                    const newRegs = Math.floor(Math.random() * 3) + 1;
                    
                    charts.traffic.data.datasets[0].data.push(newVisits);
                    charts.traffic.data.datasets[0].data.shift();
                    charts.traffic.data.datasets[1].data.push(newRegs);
                    charts.traffic.data.datasets[1].data.shift();
                    
                    // Calculo de Conversion Rate Real-ish
                    const rate = ((newRegs / newVisits) * 100).toFixed(1);
                    document.getElementById('kpi-conv').innerText = rate;
                    
                    charts.traffic.update('none');
                }
            } catch (e) { console.error("Stats Error", e); }
        }

        // --- CORE FUNCTIONS (Chat & Users) ---
        // (Mantenemos la l贸gica de Chat inteligente y User List de la versi贸n anterior)
        async function fetchUsers() {
            const container = document.getElementById('user-list');
            try {
                const res = await fetch(`${API_URL}/users`);
                const users = await res.json();
                container.innerHTML = '';
                if(users.length === 0) { container.innerHTML = '<div class="text-center text-gray-600 text-[10px] py-4">Sin datos</div>'; return; }
                users.forEach(user => {
                    const div = document.createElement('div');
                    div.className = "p-2 rounded bg-white/5 hover:bg-white/10 cursor-pointer border border-transparent hover:border-emerald-500/30 transition mb-1 animate-fade-in";
                    div.onclick = () => selectUser(user);
                    div.innerHTML = `<div class="flex justify-between"><span class="font-bold text-xs text-white">${user.nombre}</span><span class="text-[9px] bg-white/10 px-1.5 rounded text-gray-400 uppercase">${user.nivel}</span></div><div class="text-[9px] text-gray-500 truncate">ID: ${user.id}</div>`;
                    container.appendChild(div);
                });
            } catch(e) { container.innerHTML = '<div class="text-red-500 text-[10px]">Error API</div>'; }
        }

        function selectUser(user) {
            document.getElementById('ai-input').value = user.id;
            switchView('chat');
            selectedUserId = user.id;
        }

        async function handleAiSubmit(e) {
            e.preventDefault();
            const input = document.getElementById('ai-input');
            const val = input.value.trim();
            if (!val) return;
            
            const isNumber = /^\d+$/.test(val);
            let payload = isNumber ? { userId: parseInt(val) } : { prompt: val, userId: selectedUserId };
            
            addMessageToChat('user', isNumber ? `Analizar ID: ${val}` : val);
            input.value = ''; input.disabled = true;
            
            try {
                const res = await fetch(BRAIN_URL, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                const json = await res.json();
                if (json.success) {
                    json.mode === 'analysis' && json.data ? renderAnalysisCard(json.data) : addMessageToChat('system', json.response);
                } else {
                    addMessageToChat('system', `Error: ${json.message || 'Desconocido'}`, true);
                }
            } catch (e) { addMessageToChat('system', 'Error conexi贸n IA', true); }
            finally { input.disabled = false; input.focus(); }
        }

        function addMessageToChat(role, html, isErr) {
            const box = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.className = "flex gap-3 items-start animate-fade-in mb-4";
            div.innerHTML = role === 'user' ? 
                `<div class="w-6 h-6 rounded-full bg-gray-700 flex items-center justify-center text-xs"></div><div class="text-xs text-gray-300 pt-1">${html}</div>` : 
                `<div class="w-6 h-6 rounded-full bg-emerald-900 flex items-center justify-center text-xs"></div><div class="text-xs ${isErr?'text-red-400':'text-emerald-100'} pt-1 leading-relaxed whitespace-pre-wrap">${html}</div>`;
            box.appendChild(div); box.scrollTop = box.scrollHeight;
        }

        function renderAnalysisCard(data) {
            addMessageToChat('system', `<div class="bg-black/40 border border-emerald-500/30 rounded p-3"><div class="flex justify-between mb-2 pb-2 border-b border-white/10"><span class="text-emerald-400 font-bold text-[10px] uppercase">An谩lisis</span></div><div class="text-xs text-white mb-1">Perfil: <b>${data.arquetipo}</b></div><div class="text-xs text-emerald-400 mb-2">Probabilidad: ${data.probabilidad_compra}%</div><div class="bg-emerald-500/10 p-2 rounded text-[10px] text-emerald-100 italic border border-emerald-500/20">"${data.mensaje_push}"</div></div>`);
        }

        function addLiveEvent() {
            const box = document.getElementById('live-feed');
            const types = ['click_nav', 'view_promo', 'login', 'db_sync', 'pass_install', 'geo_scan'];
            const type = types[Math.floor(Math.random() * types.length)];
            let color = type.includes('pass') ? 'text-blue-400' : (type.includes('scan') ? 'text-yellow-400' : 'text-gray-400');
            const div = document.createElement('div');
            div.className = `border-l border-white/10 pl-2 animate-fade-in ${color}`;
            div.innerHTML = `<span class="text-emerald-700">[${new Date().toLocaleTimeString().split(' ')[0]}]</span> ${type}`;
            box.prepend(div);
            if(box.children.length > 15) box.lastChild.remove();
            setTimeout(addLiveEvent, Math.random() * 3000 + 1000);
        }

        // Init
        fetchUsers(); fetchStats(); addLiveEvent(); setInterval(fetchStats, 5000);
    </script>
</body>
</html>
